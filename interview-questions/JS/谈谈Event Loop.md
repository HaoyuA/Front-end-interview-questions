EventLoop 即是JavaScript内部采用的事件循环机制，  这得首先从JS的单线程特点说起。。

#### JavaScirpt 为什么要设计成单线程？

首先JavaScript采用的是**单线程模型**，单线程模型指的是，JavaScript 只在一个线程上运行 但是其实JavaScript引擎有多个线程，而单个脚本只能在一个线程上运行(称为主线程)，其他线程都是在后台配合

试想如果JavaScript采用多线程，那么一个线程要在网页DOM上节点添加内容，另一个要删除这个节点，那么浏览器应该以哪个线程为准？ 是不是还要加锁机制？ 因此为了不让JavaScript变得那么复杂 就一开始就设计成了单线程

单线程的的话，遇到异步任务怎么办？假如我发起了一个ajax 请求 如果对方迟迟没有反应 或者网络堵塞，那么这时候后面的任务不都得排队等着，那个网页不就卡住了？ 那么怎么办呢？

但是实际上CPU在处理这些任务的时候其实是空闲的 只是由于IO操作很慢(比如ajax) 不得不等结果才能进行下一步操作 于是JavaScript 语言的设计者意识到，这时 CPU 完全可以不管 IO 操作，挂起处于等待中的任务，先运行排在后面的任务。等到 IO 操作返回了结果，再回过头，把挂起的任务继续执行下去。这种机制就是 JavaScript 内部采用的“事件循环”机制（Event Loop）。

为了利用多核 CPU 的计算能力，HTML5 提出 Web Worker 标准，允许 JavaScript 脚本创建多个线程，但是子线程完全受主线程控制，且不得操作 DOM。所以，这个新标准并没有改变 JavaScript 单线程的本质。



#### 任务队列

任务分同步和异步 所有同步任务都会在主线程上执行，形成一个执行栈（execution context stack）只有前一个执行完毕后一个才能执行， 而异步任务不同的地方是，它们会进入一个 任务队列中 （task queue） 只有任务队列 通知主线程说这个异步任务可以执行了，该任务才会进入主线程才会执行 

所以一个异步任务的运行机制如下：

1. 所有同步任务都在主线程上执行，形成一个[执行栈](http://www.ruanyifeng.com/blog/2013/11/stack.html)（execution context stack）。

2. 主线程之外，还存在一个"任务队列"（task queue）。只要异步任务**有了运行结果**，就在"任务队列"之中放置一个事件。

3. 一旦"执行栈"中的所有同步任务执行完毕，系统就会读取"任务队列"，看看里面有哪些事件。那些对应的异步任务，于是结束等待状态，进入执行栈，开始执行。

4. 主线程不断重复上面的第三步。



任务队列中存的是什么？

不是函数，可以说是事件，也可以理解成消息， IO 设备完成一项任务，比如ajax请求成功了得到了request.responseText，那么就会在'任务队列中添加一个事件'，主线程读取任务队列，就是在读里面有哪些事件。

任务队列中的事件除了 IO设备的事件外，也包括用户产生的事件，比如鼠标点击等，只要指定过回调函数，这些事件就会进入任务队列等待主线程读取

所谓回调函数，就是指会被主线程挂起来的代码，异步任务必须指定回调函数，当主线程执行异步任务实际上就是执行对应的回调函数。





#### **EvenLoop** 

我们再回过头来看看什么是EventLoop

主线程从任务队列中读取事件这个过程是循环不断的，所以这整个运行机制又称为EventLoop

![eventloop-1](/assets/eventloop-1.png)

主线程运行的时候，会产生堆(heap)和栈(stack)，栈中的代码需要**调用各种外部的API**，它们会在"任务队列"中去加入各种事件(click,load,done) 只要栈中的代码执行完毕，主线程就会去读取

"任务队列" 依次执行那些事件的回调函数



除了放置任务的事件，任务队列还可以放置定时事件，即指定某些代码在多少时间后执行



#### 宏任务和微任务

其中异步任务又分为宏任务(macrotask)和微任务(microtask)

典型的微任务是

promise `.then/catch/finally`处理的程序执行  queueMicrotask(fn) 中的fn 

典型的宏任务是

setTimeout、setInterval

所以 Event Loop 时间循环可以简单描述成以下步骤：

1. 函数被压入执行栈，如果遇到异步函数，就会丢给WebAPIs，接着执行同步任务，直到Stack 为空
2. 在此期间WebAPIs完成了 任务后 会把回调函数放到队列中等待执行 (微任务放微任务队列，宏任务放宏任务队列)
3. 执行栈空时，就会去，就会把微任务队列清空
4. 然后进入宏任务队列，去队列第一项放入Stack(栈)中执行 回到第一步



[官方文档 看的我是真头痛](https://html.spec.whatwg.org/multipage/webappapis.html#event-loop)

